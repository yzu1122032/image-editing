<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>濾鏡編輯</title>
    <style>
        body {
            font-family: '微軟正黑體';
            background: #e8edf0;
            text-align: center;
            padding: 30px;
        }

        h2 {
            font-size: 28px;
            margin-bottom: 20px;
        }

        .preview {
            display: inline-block;
            border: 6px solid black;
            border-radius: 20px;
            margin: 0 auto 30px;
            overflow: hidden;
        }

        .preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .filters {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .filter-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .filter-option img {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            margin-bottom: 6px;
        }

        .filter-option span {
            font-size: 14px;
        }

        .action-btns {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .action-btns button {
            background: #b2dff0;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h2>濾鏡</h2>

    <div class="action-btns">
        <button onclick="resetFilter()">⟲</button>
        <button onclick="saveResult()">✓</button>
    </div>

    <div id="previewWrapper" class="preview">
        <img id="previewImage" src="" alt="預覽圖片">
    </div>

    <div class="filters">
        <div class="filter-option" onclick="applyFilter('none')">
            <img src="icon-none.png" alt="無">
            <span>無</span>
        </div>
        <div class="filter-option" onclick="applyFilter('sepia(0.6)')">
            <img src="icon-sepia.png" alt="復古">
            <span>復古</span>
        </div>
        <div class="filter-option" onclick="applyFilter('grayscale(1)')">
            <img src="icon-bw.png" alt="黑白">
            <span>黑白</span>
        </div>
        <div class="filter-option" onclick="applyFilter('contrast(150%)')">
            <img src="icon-contrast.png" alt="對比">
            <span>對比</span>
        </div>
        <div class="filter-option" onclick="applyFilter('blur(2px)')">
            <img src="icon-blur.png" alt="模糊">
            <span>模糊</span>
        </div>
        <div class="filter-option" onclick="applyFilter('brightness(1.3)')">
            <img src="icon-bright.png" alt="明亮">
            <span>明亮</span>
        </div>
    </div>

    <script>
        const previewImage = document.getElementById('previewImage');
        const previewWrapper = document.getElementById('previewWrapper');
        const images = JSON.parse(localStorage.getItem('collageImages')) || [];
        let currentFilter = 'none';

        if (images.length === 1) {
            previewImage.src = images[0];
        } else {
            window.location.href = 'template.html';
        }

        previewImage.onload = () => {
            const ratio = previewImage.naturalWidth / previewImage.naturalHeight;
            let width = 640;
            let height = width / ratio;

            if (height > 480) {
                height = 480;
                width = height * ratio;
            }

            previewWrapper.style.width = width + 'px';
            previewWrapper.style.height = height + 'px';
        }

        function applyFilter(filter) {
            currentFilter = filter;
            previewImage.style.filter = filter;
        }

        function resetFilter() {
            applyFilter('none');
        }

        function saveResult() {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.filter = currentFilter;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/png');

                // ✅ 儲存至 collageImages，返回 editor
                localStorage.setItem('collageImages', JSON.stringify([dataUrl]));
                window.location.href = 'editor.html';
            };
            img.crossOrigin = 'anonymous';
            img.src = previewImage.src;
        }
        function saveResult() {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.filter = currentFilter;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/png');

                // ✅ 儲存至 collageImages，返回 editor
                localStorage.setItem('collageImages', JSON.stringify([dataUrl]));
                window.location.href = 'editor.html';
            };
            img.crossOrigin = 'anonymous';
            img.src = previewImage.src;
        }

    </script>
</body>

</html>